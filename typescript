import { QuickAddInventoryDialog } from "@/components/research/QuickAddInventoryDialog";

interface RequirementsTableProps {
  items: any[];
  onStartJob: (targetItemId: Id<"inventory"> | string, quantity: number, components: any[]) => void;
  onCreateItem?: (name: string) => void;
}

export function RequirementsTable({ items, onStartJob, onCreateItem }: RequirementsTableProps) {
  const [expandedRows, setExpandedRows] = useState<Record<string, boolean>>({});

  const [createItemOpen, setCreateItemOpen] = useState(false);
  const [newItemName, setNewItemName] = useState("");

  useEffect(() => {
    if (open) {
      setForm(prev => ({
        ...prev,
        name: defaultName || "",
        type: defaultType || "raw",
        subcategory: defaultSubcategory || "",
      }));
    }
  }, [open, defaultName, defaultType, defaultSubcategory]);

  useEffect(() => {
    if (foundItem) {
      // ...
    } else {
      // 3. Try "[Kit Name] [Packet Name]" (with brackets)
      const kitName = kit.name.trim();
      const bracketedName = `[${kitName}] ${packetName}`;
      requirements.push({
        id: `missing_${bracketedName}`,
        name: bracketedName,
        // ...
      });
    }
  }, [foundItem, kit, packetName]);

  const showBom = ["pre_processed", "finished", "sealed_packet"].includes(form.type);

  const handleCreateItem = (name: string) => {
    setNewItemName(name);
    setCreateItemOpen(true);
  };

  const isMissing = typeof item.id === 'string' && item.id.startsWith('missing_');
  
  return (
    <>
      {items.map((item, idx) => {
        const rowKey = `${item.id}_${idx}`;
        const hasComponents = item.components && item.components.length > 0;
        const hasDeficit = item.shortage > 0;
        const hasSurplus = item.surplus > 0;
        
        return (
          <>
            <TableRow key={idx}>
              <TableCell>
                {item.name}
              </TableCell>
              <TableCell>
                {item.type}
              </TableCell>
              <TableCell>
                {item.subcategory}
              </TableCell>
              <TableCell>
                {item.shortage}
              </TableCell>
              <TableCell>
                {item.surplus}
              </TableCell>
              <TableCell>
                {hasDeficit && (
                  <Badge variant="destructive">Deficit: {item.shortage} {item.unit}</Badge>
                )}
                {hasSurplus && (
                  <Badge variant="secondary">Surplus: {item.surplus} {item.unit}</Badge>
                )}
                {!hasDeficit && !hasSurplus && (
                  <Badge variant="outline">Exact Match</Badge>
                )}
              </TableCell>
              <TableCell>
                {isMissing ? (
                  onCreateItem && (
                    <Button 
                      size="sm" 
                      variant="outline"
                      onClick={() => onCreateItem(item.name)}
                    >
                      <Package className="mr-2 h-4 w-4" />
                      Create Item
                    </Button>
                  )
                ) : (
                  hasDeficit && (
                    <Button 
                      size="sm" 
                      onClick={() => onStartJob(item.id, item.shortage, item.components)}
                    >
                      <Package className="mr-2 h-4 w-4" />
                      Start Job
                    </Button>
                  )
                )}
              </TableCell>
            </TableRow>
          </>
        );
      })}
    </>
  );
}